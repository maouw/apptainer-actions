#!/usr/bin/env bash
set -eu${XTRACE:-} -o pipefail

echo XTRACE="${XTRACE:-}" >>"${GITHUB_ENV}"
echo INPUT_BIND="${INPUT_BIND:-}" >>"${GITHUB_ENV}"
echo INPUT_BUILD_ARGS="${INPUT_BUILD_ARGS:-}" >>"${GITHUB_ENV}"
echo INPUT_BUILD_ARG_FILE="${INPUT_BUILD_ARG_FILE:-}" >>"${GITHUB_ENV}"
echo INPUT_DISABLE_CACHE="${INPUT_DISABLE_CACHE:-}" >>"${GITHUB_ENV}"
echo INPUT_FAKEROOT="${INPUT_FAKEROOT:-}" >>"${GITHUB_ENV}"
echo INPUT_FIX_PERMS="${INPUT_FIX_PERMS:-}" >>"${GITHUB_ENV}"
echo INPUT_FORCE="${INPUT_FORCE:-}" >>"${GITHUB_ENV}"
echo INPUT_JSON="${INPUT_JSON:-}" >>"${GITHUB_ENV}"
echo INPUT_MOUNT="${INPUT_MOUNT:-}" >>"${GITHUB_ENV}"
echo INPUT_NOTEST="${INPUT_NOTEST:-}" >>"${GITHUB_ENV}"
echo INPUT_SECTION="${INPUT_SECTION:-}" >>"${GITHUB_ENV}"
echo INPUT_UPDATE="${INPUT_UPDATE:-}" >>"${GITHUB_ENV}"
echo INPUT_USERNS="${INPUT_USERNS:-}" >>"${GITHUB_ENV}"
echo INPUT_WRITABLE_TMPFS="${INPUT_WRITABLE_TMPFS:-}" >>"${GITHUB_ENV}"
echo INPUT_TAGS="${INPUT_TAGS:-}" >>"${GITHUB_ENV}"
echo INPUT_ADD_TAGS="${INPUT_ADD_TAGS:-}" >>"${GITHUB_ENV}"
echo INPUT_DEFFILE="${INPUT_DEFFILE:-}" >>"${GITHUB_ENV}"
echo INPUT_DEFFILES_ROOTDIR="${INPUT_DEFFILES_ROOTDIR:-}" >>"${GITHUB_ENV}"
echo INPUT_NAME="${INPUT_NAME:-}" >>"${GITHUB_ENV}"
echo INPUT_IMAGE_URL="${INPUT_IMAGE_URL:-}" >>"${GITHUB_ENV}"
echo INPUT_IMAGE_VERSION="${INPUT_IMAGE_VERSION:-}" >>"${GITHUB_ENV}"
echo BUILD_LABELS_PATH="${BUILD_LABELS_PATH:-${RUNNER_TEMP:-/tmp}/.build.labels}" >>"${GITHUB_ENV}"
echo INPUT_IMAGE_DIR="${INPUT_IMAGE_DIR:-}" >>"${GITHUB_ENV}"
echo INPUT_IMAGE_PATH="${INPUT_IMAGE_PATH:-}" >>"${GITHUB_ENV}"
echo INPUT_APPTAINER_TMPDIR="${INPUT_APPTAINER_TMPDIR:-}" >>"${GITHUB_ENV}"

GITHUB_TOKEN="${GITHUB_TOKEN:-${GH_TOKEN:-"$(gh auth token || true)"}}"

if [[ -n "${GITHUB_TOKEN:-}" ]]; then    
    echo GITHUB_TOKEN="${GITHUB_TOKEN}" >>"${GITHUB_ENV}"
    echo GH_TOKEN="${GITHUB_TOKEN}" >>"${GITHUB_ENV}"
fi
